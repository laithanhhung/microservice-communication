---
import { getEntry } from 'astro:content';

interface Props {
  contentId: string;
  position?: 'top' | 'bottom' | 'left' | 'right';
}

const { contentId, position = 'top' } = Astro.props;
const entry = await getEntry('patterns', contentId);

let Content;
if (entry) {
    const rendered = await entry.render();
    Content = rendered.Content;
}

// Logic positioning classes
const positionClasses = {
    top: 'bottom-full mb-3',
    bottom: 'top-full mt-3',
    left: 'right-full mr-3 top-1/2 -translate-y-1/2',
    right: 'left-full ml-3 top-1/2 -translate-y-1/2'
};

const arrowClasses = {
    top: 'left-1/2 -translate-x-1/2 -bottom-2 border-b border-r',
    bottom: 'left-1/2 -translate-x-1/2 -top-2 border-t border-l',
    left: 'top-1/2 -translate-y-1/2 -right-2 border-t border-r',
    right: 'top-1/2 -translate-y-1/2 -left-2 border-b border-l'
};

const mainClasses = positionClasses[position] || positionClasses.top;
const arrowPosClasses = arrowClasses[position] || arrowClasses.top;
---

{entry ? (
    <div class={`hover-tooltip-container absolute w-96 bg-white rounded-lg p-5 shadow-2xl opacity-0 invisible transition-all duration-300 z-50 text-left border border-gray-100 pointer-events-none ${mainClasses} ${position === 'left' || position === 'right' ? '' : 'left-1/2 -translate-x-1/2'}`}>
         <!-- Arrow -->
         <div class={`tooltip-arrow absolute w-4 h-4 bg-white transform rotate-45 border-gray-100 ${arrowPosClasses}`}></div>
         
         <div class="prose prose-sm prose-slate max-w-none">
             <h3 class="text-gray-900 font-bold text-lg mb-2">{entry.data.title}</h3>
             <div class="text-gray-600 leading-relaxed">
                 <Content />
             </div>
         </div>
    </div>
) : (
    <div class="hidden">Content not found for {contentId}</div>
)}

<script>
    function setupTooltips() {
        const tooltips = document.querySelectorAll('.hover-tooltip-container');
        
        tooltips.forEach((elem) => {
            const tooltip = elem as HTMLElement;
            const parent = tooltip.parentElement;
            if (!parent) return;

            parent.addEventListener('mouseenter', () => {
                // Show basic state
                tooltip.classList.remove('opacity-0', 'invisible');
                tooltip.classList.add('opacity-100', 'visible');
            });

            parent.addEventListener('mouseleave', () => {
                 tooltip.classList.add('opacity-0', 'invisible');
                 tooltip.classList.remove('opacity-100', 'visible');
            });
        });
    }

    // Run on initial load
    setupTooltips();

    // Support View Transitions
    document.addEventListener('astro:page-load', setupTooltips);
</script>
